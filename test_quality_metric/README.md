# test_quality_metric

Scripts and data for evaluating property-based test quality against a pandas API target.

---

## Quick start

All commands run from the **repository root**.

### 1 — Run the full quality pipeline for one test suite

```bash
# IR-generated test (default)
bash test_quality_metric/run_quality_report.sh \
    test_quality_metric/pandas/DataFrame/reindex

# Baseline test
bash test_quality_metric/run_quality_report.sh \
    test_quality_metric/pandas/DataFrame/reindex --use_baseline

# Explicit test file
bash test_quality_metric/run_quality_report.sh \
    test_quality_metric/pandas/DataFrame/reindex \
    ir2test_pipeline/pandas/DataFrame/reindex/ir_generated_test.py
```

Outputs land in `<target-dir>/results/<test_stem>/`:

| File | What it contains |
|------|-----------------|
| `kill_report.json` / `kill_report.md` | Per-mutant kill/survive status, mutation score |
| `coverage.json` | Method-level line coverage + branch coverage |
| `properties_llm_trace.json` | LLM judgment of clause ↔ test coverage |
| `properties_coverage.json` | Aggregated clause satisfaction stats |
| `overall_report_<stem>.md` | Human-readable summary of all metrics |

> Requires `DEEPSEEK_API_KEY` in `.env` for the LLM clause trace step.

---

### 2 — Compare suites side-by-side

```bash
# All eligible functions (no args needed)
uv run python test_quality_metric/compare_results.py

# Single function
uv run python test_quality_metric/compare_results.py \
    --target-dir test_quality_metric/pandas/DataFrame/reindex

# Override which two suites to compare
uv run python test_quality_metric/compare_results.py \
    --target-dir test_quality_metric/pandas/DataFrame/reindex \
    --suite-a baseline_test \
    --suite-b ir_generated_test
```

A directory is **eligible** when its `results/` folder contains at least two non-`old*`
suite directories each with `kill_report.json`, `coverage.json`, and `properties_coverage.json`.

Each eligible directory gets its own report written to:

```
<target-dir>/results/comparison_report.md
```

The report contains five sections:

| Section | Compares |
|---------|----------|
| 1. Baseline Test Status | Which tests pass/fail in each suite |
| 2. Mutant Kill | Per-mutant killed/survived, mutation score delta |
| 3. Coverage | Method line coverage and branch coverage delta |
| 4. Properties Coverage | Per-clause ✅/❌, satisfaction count delta |
| 5. Summary | One-line winner per metric |

---

## Directory layout

```
test_quality_metric/
├── run_quality_report.sh        # Full pipeline (mutants → coverage → LLM → report)
├── run_mutant_eval.py           # Mutation testing runner
├── run_api_coverage.py          # Line/branch coverage runner
├── llm_clause_trace.py          # LLM clause-satisfaction tracer
├── calc_properties_coverage.py  # Aggregates LLM trace → coverage stats
├── compare_results.py           # Side-by-side comparison report generator
└── pandas/
    └── DataFrame/
        └── reindex/
            ├── metadata.json        # {"qualified_name": "pandas.DataFrame.reindex", ...}
            ├── clauses.json         # 20 behavioural clauses (C1–C20)
            ├── mutants/
            │   ├── mapping.json
            │   └── reindex_mutants.py
            └── results/
                ├── baseline_test/
                │   └── overall_report_baseline_test.md
                ├── ir_generated_test/
                │   └── overall_report_ir_generated_test.md
                └── comparison_report.md   ← generated by compare_results.py
```

## Individual scripts

```bash
# Mutation evaluation only
uv run python test_quality_metric/run_mutant_eval.py \
    --mapping-file  test_quality_metric/pandas/DataFrame/reindex/mutants/mapping.json \
    --mutants-file  test_quality_metric/pandas/DataFrame/reindex/mutants/reindex_mutants.py \
    --output-dir    test_quality_metric/pandas/DataFrame/reindex/results \
    --pytest-file   ir2test_pipeline/pandas/DataFrame/reindex/ir_generated_test.py \
    --workers 4

# Coverage only
uv run python test_quality_metric/run_api_coverage.py \
    --api   pandas.DataFrame.reindex \
    --test  ir2test_pipeline/pandas/DataFrame/reindex/ir_generated_test.py \
    --json-out test_quality_metric/pandas/DataFrame/reindex/results/ir_generated_test/coverage.json

# LLM clause trace only
uv run python test_quality_metric/llm_clause_trace.py \
    --target-dir test_quality_metric/pandas/DataFrame/reindex \
    --test-file  ir2test_pipeline/pandas/DataFrame/reindex/ir_generated_test.py \
    --out-json   test_quality_metric/pandas/DataFrame/reindex/results/ir_generated_test/properties_llm_trace.json
```
